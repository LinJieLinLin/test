var module=angular.module("RCP",["ngCookies"]);module.controller("circleDetailCtrl",["$scope","$rootScope",function(e,t){$("body").show(),e.circleConfig={rUrl:DYCONFIG.studyCircle.rUrl,category:"10"},e.circleDetailConfig={rUrl:DYCONFIG.studyCircle.rUrl,category:"10"}}]),module.factory("course",["request",function(e){var t=DYCONFIG.course.rUrl;return{getCourseDetail:function(n,a){n.token=rcpAid.getToken();var r={method:"GET",url:t+"pub/api/loadCourse",params:n};return e(angular.extend(r,a||{}))},getTeacherCourses:function(n,a){n.token=rcpAid.getToken(),n.isSelf=1;var r={method:"GET",url:t+"pub/api/searchCourse",params:n};return e(angular.extend(r,a||{}))},joinFreeCourse:function(n,a){n.token=rcpAid.getToken();var r={method:"GET",url:t+"usr/api/joinCourse",params:n};return e(angular.extend(r,a||{}))},searchCourse:function(n,a){var r={method:"GET",url:t+"pub/api/searchCourse",params:n};return e(angular.extend(r,a||{}))},verifyCourse:function(n,a){n.token=rcpAid.getToken();var r={method:"GET",url:t+"usr/api/verifyCourse",params:n};return e(angular.extend(r,a||{}))},createCourse:function(n,a,r){n.token=rcpAid.getToken();var i={method:"POST",url:t+"usr/api/createCourse",params:n,data:r};return e(angular.extend(i,a||{}))},getStudentCourse:function(n,a){n.token=rcpAid.getToken(),n.isSelf=10;var r={method:"GET",url:t+"pub/api/searchCourse",params:n};return e(angular.extend(r,a||{}))},releaseCourse:function(n,a){n.token=rcpAid.getToken();var r={method:"GET",url:t+"usr/api/releaseCourse",params:n};return e(angular.extend(r,a||{}))},saveCourseData:function(n,a){var r={};r.token=rcpAid.getToken();var i={method:"POST",url:t+"usr/api/updateCourse",params:r,data:n};return e(angular.extend(i,a||{}))},cancelCourse:function(n,a){n.token=rcpAid.getToken();var r={method:"POST",url:t+"usr/api/cancelCourse",params:n};return e(angular.extend(r,a||{}))},getListGroup:function(n,a){n.token=rcpAid.getToken();var r={method:"GET",url:t+"pub/api/listGroup",params:n};return e(angular.extend(r,a||{}))},getAllTags:function(t,n){t.token=rcpAid.getToken();var a={method:"POST",url:DYCONFIG.pes.rUrl+'pub/api/page/GetPage?keys=[{"key":"p_classifi"}]',params:t};return e(angular.extend(a,n||{}))},updateArticleExt:function(n,a){n.token=rcpAid.getToken();var r={method:"GET",url:t+"usr/api/updateExt",params:n};return e(angular.extend(r,a||{}))},getArticleExt:function(n,a){n.token=rcpAid.getToken();var r={method:"GET",url:t+"pub/api/listArtExt",params:n};return e(angular.extend(r,a||{}))},loadRecord:function(n,a){n.token=rcpAid.getToken();var r={method:"GET",url:t+"pub/api/loadRecord",params:n};return e(angular.extend(r,a||{}))}}}]),module.run(["service","course",function(e,t){e.expand("course",function(){return t})}]);try{if("object"!=typeof module)var module=angular.module("directive",[])}catch(e){var module=angular.module("directive",[])}if(module.directive("placeholder",function(){return{restrict:"A",require:"?ngModel",link:function(e,t,n,a){try{var r="<style>.placeholder-style{color: gray;};</style>";0===document.getElementsByClassName("placeholder-style").length&&angular.element(document).find("head").append(r);var i=function(e,t){var n,a=window.navigator.userAgent.toLowerCase();if(-1!==a.indexOf("msie")){var r=a.match(/msie\s([0-9]*)/);n=0===arguments.length?r[1]:1===arguments.length?parseInt(r[1])===e:r[1]>=e&&r[1]<=t?r[1]:!1}return n};if(i(8,9)){a.$modelValue||a.$modelValue===!1||0===a.$modelValue||(t.val(n.placeholder),t.addClass("placeholder-style"));try{a.$setViewValue()}catch(o){}if("password"===n.type){t.removeClass("placeholder-style");var s=(new Date).getTime(),c=n.style||"",l=n["class"]||"";t.after('<input id="'+s+'" type="text" value="'+n.placeholder+'" autocomplete="off" style="'+c+'" class="'+l+' placeholder-style" />');var d=t.next();d.css("display","inline-block"),t.css("display","none"),d.on("focus",function(){t.css("display","inline-block"),d.css("display","none"),t.on("focus",function(){})})}var u=!1;t.on("focus",function(){u=!0,"password"===n.type?a.$modelValue||t.val(""):(t.removeClass("placeholder-style"),t.val()!==n.placeholder||a.$modelValue&&a.$modelValue!==n.placeholder||t.val(""))}),t.on("blur",function(){u=!1,"password"===n.type?""===t.val()&&(d.css("display","inline-block"),t.css("display","none")):t.val()||a.$modelValue||(t.val(n.placeholder),t.addClass("placeholder-style"))}),e.$watch(function(){return a.$modelValue},function(e){e?t.removeClass("placeholder-style"):u===!1&&(t.val(n.placeholder),t.addClass("placeholder-style"))})}}catch(o){}}}}),module.factory("studyCircle",["request",function(e){var t=DYCONFIG.studyCircle.rUrl||"/";return{sendCircle:function(n,a){n.token=rcpAid.getToken();var r={method:"POST",url:t+"usr/api/createDiscuss",params:n};return e(angular.extend(r,a||{}))},getCircleList:function(n,a){n.token=rcpAid.getToken();var r={method:"POST",url:t+"pub/api/searchDiscuss",params:n};return e(angular.extend(r,a||{}))},getCircleDetail:function(n,a){n.token=rcpAid.getToken();var r={method:"GET",url:t+"pub/api/getCDetail",params:n};return e(angular.extend(r,a||{}))},setReadCount:function(n,a){n.token=rcpAid.getToken();var r={method:"GET",url:t+"pub/api/statRead",params:n};return e(angular.extend(r,a||{}))},getPersonDiscuss:function(n,a){n.token=rcpAid.getToken();var r={method:"GET",url:t+"pub/api/personDiscuss",params:n};return e(angular.extend(r,a||{}))},removeDiscuss:function(n,a){n.token=rcpAid.getToken();var r={method:"GET",url:t+"usr/api/delDiscuss",params:n};return e(angular.extend(r,a||{}))},getPersonReply:function(n,a){n.token=rcpAid.getToken();var r={method:"GET",url:t+"pub/api/personReply",params:n};return e(angular.extend(r,a||{}))}}}]),module.run(["service","studyCircle",function(e,t){e.expand("studyCircle",function(){return t})}]),!module)var module=angular.module("RCP",[]);if(module.filter("sanitize",["$sce",function(e){return function(t){return e.trustAsHtml(t)}}]),module.directive("studyCircleDetail",["$timeout",function(e){return{template:'<div class="study-circle"><div class="content-section"><h3 class="content-section-head-1"><a ng-href="{{goCircleTotal}}" target="_blank">学习圈子</a> <span>&gt; 圈子详情</span></h3><div class="content-section-body"><ul class="circle-detail circle-detail-1"><li class="inline"><div class="user-info"><img class="img-circle" src="{{rootInfo.avatar || \'../study-circle/imgs/d-face-1.png\'}}" alt=""></div><div class="detail-1"><div><p ng-bind="rootInfo.nickName"></p></div><div ng-bind-html="rootInfo.root.content | sanitize"></div><image-slider images="circleData.root.files.IMG" class="self-image-slider"></image-slider><p class="desc-1"><span class="date" ng-bind="rootInfo.root.createTime| date:\'MM-dd HH:mm\'"></span> <span ng-bind="rootInfo.root.count.readCount+\'阅读\'"></span> <span class="vote"><button ng-click="sendLike(rootInfo.root)"><i class="fa fa-thumbs-o-up" ng-show="rootInfo.root.isLiked" style="color:#fe8811"></i> <i class="fa fa-thumbs-o-up" ng-hide="rootInfo.root.isLiked"></i> <span ng-bind="rootInfo.root.count.likeCount">186</span></button> <button><i class="fa fa-share-alt"></i> <span>分享</span></button></span></p><button ng-click="scoreTo(\'reply\',\'relay-circle\',false)">回复</button></div></li></ul></div><div class="reply-body"><div ng-bind="rootInfo.root.count.replyCount+\'个回复\'"></div><div class="reply-list" ng-repeat="r in circleData.replys track by $index"><div class="user-info"><img class="img-circle" ng-src="{{usrList[r.ownerId].attrs.basic.avatar ||\'../study-circle/imgs/d-face-1.png\'}}" alt=""></div><div class="reply-content"><div class="header"><div class="f-l"><span ng-bind="usrList[r.ownerId].attrs.basic.nickName"></span> <span ng-bind="(r.createTime| date:\'MM-dd HH:mm\')">11-18 19:33</span></div><div class="f-r" ng-click="sendLike(r)"><button><i class="fa fa-thumbs-o-up" ng-show="r.isLiked" style="color:#fe8811"></i> <i class="fa fa-thumbs-o-up" ng-hide="r.isLiked"></i> <span>赞</span></button> <span ng-bind="\'（\'+r.count.likeCount+\'）\'">（0）</span></div></div><div class="body"><div ng-bind-html="r.content | sanitize"></div><div class="comment c" ng-click="scoreTo(\'\',\'\',true,r,$index);"><span ng-bind="\'评论（\'+r.count.replyCount+\'）\'">评论（2）</span></div></div><div class="reply-orther"><div class="content" ng-repeat="re in r.comments track by $index"><div class="user-info"><img class="img-circle" src="../study-circle/imgs/d-face-1.png" alt=""></div><div class="content-d"><div><span ng-bind="usrList[re.ownerId].attrs.basic.nickName">张同学</span> <span class="color-gray-1" ng-bind="re.createTime| date:\'MM-dd HH:mm\'"></span></div><div class="mg-t10"><span>回复<span class="at-teacher" ng-bind="\'@\'+usrList[r.ownerId].attrs.basic.nickName+\'：\'">@李老师</span> <span ng-bind-html="re.content | sanitize"></span></span></div></div></div><div class="content content-a" ng-show="r.showReply" id="personalReply-{{$index}}"><div class="textarea"><dyeditor id="" style="background:#fff;border-color:#d9d9d9" model="r.replyContent" exceed="circle.exceed" config="{id:\'reply-circle-\'+$index,len:150,style:{minHeight:80,overflow:\'auto\'},placeholder:\'请输入内容\'}"></dyeditor></div><button ng-click="sendReply(r,false)">回复</button></div></div></div><div class="clear"></div></div><div class="reply-content reply-edit" id="reply"><loader-ui show="!load.sendCircle" class="load-0"></loader-ui><dyeditor id="inputAnswer" style="background:#fff;border-color:#d9d9d9" model="rootInfo.root.replyContent" exceed="circle.exceed" config="{id:\'relay-circle\',len:150,style:{minHeight:80,overflow:\'auto\'},placeholder:\'请输入内容\'}"></dyeditor><div class="a"><a href="javascript:;" class="phiz" addface="circle.content" bindeditor="#relay-circle"><i class="fa fa-smile-o"></i></a> <a href="javascript:;" class="picture" ng-click="uploader()"><i class="fa fa-picture-o"></i></a></div><div class="b"><button ng-click="sendReply(rootInfo.root,true)">回复</button></div><div class="clear"></div></div><div class="clear"></div></div><pagination list="circleData.replys" style="margin:40px 0 0 0" pageargs="pageargs" pagefn="pagefn" deepwatch="true" class="page-bar jump-hide"></pagination></div></div>',restrict:"E",replace:!0,transclude:!0,scope:{c:"="},controller:["$scope","$timeout","$http","service",function(e,t,n,a){e.curToken=rcpAid.getToken(),e.replyCount=0,e.rootInfo={};try{e.pageargs={pn:1,ps:8,pl:5},e.pagefn=function(t,n){e.getCircleDetail(n)},e.init=function(){e.id=rcpAid.queryString("id"),e.c&&e.c.rUrl?"/"!==e.c.rUrl[e.c.rUrl.length-1]&&(e.c.rUrl+="/"):console.log("无配置文件！"),e.circle={content:"",exceed:"",isSecret:1,nowSection:""},e.usrList={},e.circleData={},e.commentCount=10,e.load={},e.getCircleDetail()},e.getCircleDetail=function(t){var n={discussId:e.id,sort:1,commentCount:e.commentCount,page:e.pageargs.pn,pageCount:e.pageargs.ps};a.studyCircle.getCircleDetail(n).then(function(r){if(console.log(r),e.circleData=r.data.discuss,e.usrList=r.data.usr,e.circleData||e.usrList||a.dialog.alert("返回数据有误"),e.circleData.root&&e.circleData.root.ownerId)try{e.rootInfo.root=e.circleData.root,e.rootInfo.avatar=e.usrList[e.circleData.root.ownerId].attrs.basic.avatar,e.rootInfo.nickName=e.usrList[e.circleData.root.ownerId].attrs.basic.nickName,0===e.rootInfo.root.count.replyCount&&(e.pageargs.pn=0)}catch(i){console.err(i)}if(!t&&e.circleData.scopes)try{var o=e.circleData.scopes[0];e.c.cid=r.data.scope[o].ownerId,e.c.type=r.data.scope[o].ownerType}catch(i){console.error(i)}"function"==typeof t&&(n.pa={pn:e.pageargs.pn,ps:e.pageargs.ps},n.pa<=8?n.pa.total=e.circleData.root.count.replyCount:n.pa.total=e.circleData.root.count.replyCount+1,t(n)),e.goCircleTotal=rcpAid.getUrl("全部圈子",{cid:e.c.cid,type:e.c.type,token:e.curToken})},function(e){console.log(e)})},e.send=function(t,n,r){var i={acl:{ALL:+e.circle.isSecret},atUsers:[],category:e.c.category||"10",coin:0,content:e.circle.content,desc:"",files:{FILE:[],IMG:[],VIDEO:[]},level:0,ownerType:"10",pOwnerId:"",pOwnerType:"",pid:"",scopes:[{OwnerId:e.c.cid,OwnerType:e.c.type}],tags:[],title:"",type:t};switch(t){case"20":if(!n.replyContent)return void a.dialog.alert("请先输入内容！");n.sendReply=!0,i.needData=!0,i.content=n.replyContent,i.pOwnerId=n.ownerId,i.pOwnerType=e.c.pOwnerType||"10",i.pid=n._id;break;case"30":n.sendLike=!0,i.pOwnerId=n.ownerId,i.pOwnerType=e.c.pOwnerType||"10",i.pid=n._id}a.studyCircle.sendCircle({token:rcpAid.getToken()},{data:angular.toJson(i)}).then(function(a){switch(t){case"20":n.sendReply=!1,n.replyContent="",r&&((parseInt(e.rootInfo.root.count.replyCount)+2)/parseInt(e.pageargs.ps)===0&&(e.pageargs.pn=1),e.pageargs.pn=Math.ceil((parseInt(e.rootInfo.root.count.replyCount)+2)/parseInt(e.pageargs.ps))),e.getCircleDetail();break;case"30":n.sendLike=!1,n.count.likeCount=+n.count.likeCount+1,n.isLiked=!0}},function(r){switch(console.log(r),t){case"10":e.load.sendCircle=!1;break;case"20":n.sendReply=!1;break;case"30":n.sendLike=!1,1003===r.data.data.code&&a.dialog.alert("您已点过赞！")}})},e.cancle=function(e){var t={ownerType:10,type:30,parentId:e._id};a.studyCircle.removeDiscuss(t).then(function(){e.isLiked=!1,e.count.likeCount=+e.count.likeCount-1,a.dialog.alert("取消点赞成功")},function(e){a.dialog.alert("取消点赞失败"),console.error(e)})},e.sendReply=function(t,n){return e.curToken?void(t.sendReply||e.send("20",t,n)):void a.common.toLogin()},e.sendLike=function(t){return console.log(t),e.curToken?t.isLiked?void e.cancle(t):void(t.sendLike||e.send("30",t)):void a.common.toLogin()},e.scoreTo=function(e,n,a,r,i){a?(r.showReply=!r.showReply,t(function(){console.log(i),$("html,body").stop().animate({scrollTop:$("#personalReply-"+i).offset().top},"normal")},50,!1),t(function(){$("#reply-circle-"+i).focus()},200,!1)):($("html,body").stop().animate({scrollTop:$("#"+e).offset().top},"normal"),t(function(){$("#"+n).focus()},0,!1))},e.init()}catch(r){console.log(r)}}]}}]),angular.module("RCP").factory("chatService",["$http","$q","$rootScope","service",function(e,t,n,a){function r(e){if(e)return localStorage.getItem("anonymousLoginToken");var t=rcpAid.getToken();return t}function i(e){be=e}function o(n){return e(n).then(function(e){var n=t.defer();return 0!==e.data.code?n.reject({type:1,data:e}):n.resolve(e.data),n.promise},function(e){throw{type:-1,data:e}})}function s(){return o({method:"GET",url:"http://"+me.SSO+"/sso/api/anonymousLogin"})}function c(){return o({url:me.friendsAddr+"/usr/get-user-grps",params:{token:Ae},method:"GET"})}function l(e,t){return o({url:me.friendsAddr+"/get-usr-info",params:{token:Ae,r:e,t:t},method:"GET",headers:{"Content-Type":void 0},option:{requestErrorMsg:!1}})}function d(e,t){return o({url:me.friendsAddr+"/get-grp-info",params:{token:Ae,r:e,cid:t},method:"GET"})}function u(){return o({url:me.friendsAddr+"/usr/get-usr-courgrp",params:{token:Ae},method:"GET"})}function g(){return o({url:me.rdisAddrSrv+"usr/api/listRinfo",params:{token:Ae},method:"GET",option:{requestErrorMsg:!1}})}function p(e){return e.sender&&"G"===e.sender[0]&&(e.reciever=e.sender,delete e.sender),o({url:me.rdisAddrSrv+"usr/api/listRecord",params:{token:Ae,s:e.sender,r:e.reciever,btime:e.beginTime,etime:e.endTime,pageNo:e.pageNo,pageSize:e.pageSize,filter:e.filter,o:e.order,sid:e.id},method:"GET",option:{requestErrorMsg:!1}}).then(function(n){var a=t.defer();a.resolve();var r=[];return n.data.list.reduce(function(t,n){var a=S(n.time).split(" ");if(n.c=Base64.decode(n.c),11===n.t)try{var i=JSON.parse(n.c),o=["亲爱的",i.userName,"同学，欢迎加入《",i.courseName,"》课程。我们将会为你规划学习路线，提供学习指引。学习过程中的任何困惑，我们都会帮助你解决。快去课程学习页学习吧!"].join(""),s=i.userName+"加入本群";i.userName===Te.name?n.c=o:n.c=s}catch(c){}return t.then(function(){return D(n.s).then(function(t){var i={day:a[0],time:a[1],t:n.time,msg:I(n),sender:t,fileType:n.t,originalMsg:n,isMine:n.s===Te.uuid,msgId:n.i};ve[e.sender]=ve[e.sender]||{},ve[e.sender][n.i]=i,r.push(i)})})},a.promise).then(function(){return{total:n.data.total,pageNo:e.pageNo,pageSize:e.pageSize,msg:r}})})}function m(e){return o({url:me.friendsAddr+"/usr/search-usr",params:{name:e.name,ps:e.ps,pn:e.pn,token:Ae},method:"GET"})}function f(e){return o({url:me.friendsAddr+"/usr/req-friend",params:{uuid:e.uuid,msg:e.msg,token:Ae},method:"GET"})}function h(e){return o({url:me.friendsAddr+"/usr/del-req-friend",params:{opt:e.action,oid:e.oid,token:Ae},method:"GET"})}function v(e){return o({url:me.friendsAddr+"/usr/list-notify",method:"GET",params:{token:Ae,t:e}})}function y(e){return o({url:me.friendsAddr+"/usr/add-discuss-grp",method:"GET",params:{token:Ae,uids:e}})}function k(){return o({url:me.friendsAddr+"/sel-help",method:"GET",params:{token:Ae}})}function b(e){return o({url:me.friendsAddr+"/usr/sel-answer",method:"GET",params:{token:Ae,uuids:e}})}function w(e,t,n){if(ye)try{console.log.apply(console,arguments)}catch(a){console.log(e,t,n)}}function x(e,t,n){var a;"undefined"!=typeof jf&&jf.alert?(a=fe.call(arguments),jf.alert(a.join(","))):(w.apply(this,arguments),a=fe.call(arguments),alert(a.join(",")))}function C(e){localStorage&&localStorage.setItem("anonymousLoginToken",e),jf.setCookie("token2",e)}function T(e){return e=e.replace(/&/g,"&gt;"),e=e.replace(/</g,"&lt;"),e=e.replace(/>/g,"&gt;"),e=e.replace(/\'/g,"&#39;"),e=e.replace(/\'/g,"&quot;"),e=e.replace(/\n/g,"<br>")}function L(e){return e>1024?e>1048576?(e/1048576).toFixed(2)+" M":Math.floor(e/1024)+" K":e+" B"}function I(e){var t,n,a,r=e.c,i=/(http|ftp|https):\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&amp;:\/~\+#]*[\w\-\@?^=%&amp;\/~\+#])?/gi;switch(e.t){case 2:try{t=JSON.parse(r),n='<a href="javascript:;" onclick="showPic(this)"><img src="'+t.url+'?s=1" /></a>'}catch(o){r=T(r),n="<div>"+r+"</div>"}break;case 3:try{t=JSON.parse(r),a=['<div class="chat-msg-file"><div class="chat-msg-file-icon"><img src="/img/icon-92.png" /></div>','<div class ="chat-msg-file-info"><span class="chat-msg-filename" title="{{name}}">','{{name}}</span><span class="chat-msg-filesize">({{size}})</span>','<p><a href ="{{url}}?dl=1" dl="1" target="_blank" download>下载</a></p></div></div>'].join(""),a=a.replace(/{{name}}/gi,t.name),a=a.replace(/{{url}}/gi,t.url),a=a.replace(/{{size}}/gi,L(t.size)),n=a}catch(o){r=T(r),n="<div>"+r+"</div>"}break;case 20:try{t=JSON.parse(r),a=['<div class="chat-recommend-course"><p class="chat-course-recommend-head">课程推荐</p>','<div class="chat-course-cover"><img src="{{img}}" /></div><div class ="chat-course-info">','<p class="chat-course-name" title="{{name}}">课程名称：{{name}}</p><p class="chat-course-teacher">创建者：{{teacher}}</p>','<p class="chat-course-action"><a href ="{{url}}" target="_blank">立即参与</a></p></div></div>'].join(""),a=a.replace(/{{img}}/gi,t.imgs.split(",")[0]||"/img/icon-65.gif"),a=a.replace(/{{name}}/gi,t.name),a=a.replace(/{{teacher}}/gi,t.userName),a=a.replace(/{{url}}/gi,"/course-detail.html?id="+t.id),n=a}catch(o){r=T(r),n="<div>"+r+"</div>"}break;default:r=T(r);var s=i.test(r);r=r.replace(i,function(e){var t='<a target="_blank" class="chat-msg-link" href="{{href}}" title="">{{href}}</a>';return t.replace(/{{href}}/gi,e)}),n=s?'<div class="chat-msg-has-link">'+r+"</div>":'<div class="chat-msg-has-content">'+r+"</div>"}return n}function S(e,t,n){var a=new Date(e),r=a.getFullYear(),i=a.getMonth()+1,o=a.getDate(),s=a.getHours(),c=a.getMinutes(),l=a.getSeconds(),d="";return i=i>9?i:"0"+i,o=o>9?o:"0"+o,s=s>9?s:"0"+s,c=c>9?c:"0"+c,l=l>9?l:"0"+l,n?(d=n.replace(/yy/g,r),d=d.replace(/mm/g,i),d=d.replace(/dd/g,o),d=d.replace(/hh/g,s),d=d.replace(/MM/g,c),d=d.replace(/ss/g,l)):[r,i,o].join("-")+" "+(t?[s,c,l].join(":"):[s,c].join(":"))}function A(e,t,n,a){return ke[e]&&ke[e].length?ke[e].push({fn:t,context:n||this,once:a}):ke[e]=[{fn:t,context:n||this,once:a}],this}function U(e){var t=fe.call(arguments,1);ke[e]&&ke[e].length&&angular.forEach(ke[e],function(e){e.once&&e.called||(e.fn.apply(e.context,t),e.called=!0)})}function E(e){e.sort(function(e){return e.online?-1:1})}function R(e){return he[e.uuid]||(e.msg=[{fileType:-1}],he[e.uuid]=e),e}function j(e,t){function n(){return t?d(void 0,t):e&&"G"===e[0]?d(e):l(e,"w")}return n().then(function(t){var n=e&&"G"===e[0]?"group":"user",a={type:n,name:t.data.name,img:t.data.img,id:t.data.id,uuid:t.data.ugid||t.data.uuid,online:"group"===n?!0:!!t.data.online,isGuest:!!t.data.tour};return R(a),t.data.users&&t.data.users.length&&angular.forEach(t.data.users,function(e){var t={type:"user",name:e.name,img:e.img,id:e.id,uuid:e.uuid,online:!!e.online};R(t)}),t})}function D(e){var n=t.defer();return he[e]?(n.resolve(he[e]),n.promise):(w("get user from server"),j(e).then(function(e){var t={type:e.data.ugid?"group":"user",name:e.data.name,img:e.data.img,id:e.data.id,uuid:e.data.ugid||e.data.uuid,online:!0,isGuest:!!e.data.tour};return t}))}function M(){var e=t.defer();return ce?le?e.resolve():A("wsConnected",function(){e.resolve()},this,!0):(ce=IM.NewIm(me.imAddr,!0),ce.on("connect",function(){return le=!0,se="pending",U("wsConnected"),G(Ae).then(function(){e.resolve()})}),N()),e.promise}function G(e){var n=t.defer();return se=se||"pending","logined"===se?n.resolve():e?(ce.emit("li",{token:e,ctype:"20"}),se="logined",U("wsLogined"),n.resolve()):s().then(function(e){C(e.data.token),se="logined",U("wsLogined"),n.resolve()},function(e){n.reject({msg:"websocket 登陆失败",err:e})}),n.promise}function _(){var e=t.defer(),a=n.$watch("anonymousUser",function(t){t&&(Ae=t.token||localStorage.getItem("anonymousLoginToken"),e.resolve(),a())});return e.promise}function N(){ce.on("li",function(e){0!==e.code?(U("wsLoginError",e),w(e.err)):(U("wsLogined"),ce.emit("ur",{}))}),ce.on("m",function(e){var t,a;if("G"===e.a[0]?(t=+e.a.split("-")[1],a=e.a):(t=+e.s.split("-")[1],a=e.s),!ve[a]||!ve[a][e.i]){if(11===e.t)try{var r=JSON.parse(e.c),i=["亲爱的",r.userName,"同学，欢迎加入《",r.courseName,"》课程。我们将会为你规划学习路线，提供学习指引。学习过程中的任何困惑，我们都会帮助你解决。快去课程学习页学习吧!"].join(""),o=r.userName+"加入本群";r.userName===Te.name?e.c=i:e.c=o,(r.userName===Te.name||n.currentUser&&1===n.currentUser.auth)&&(P(),F())}catch(s){}if(10===e.t)try{for(var c=JSON.parse(e.c),l=!1,d=0;d<Se.length;d+=1)if(Se[d].oid===c.req.oid){Se[d].status=c.req.status,l=!0;break}if(!l){if(c.req.date=S(c.req.time||(new Date).getTime()).split(" ")[0],4===c.req.status){var u={type:"user",name:c.req.rName,img:c.req.rImg,id:+c.req.r.split("-")[1],uuid:c.req.r,online:!!c.req.online};we.DEFAULT.users.push(R(u))}Se.push(c.req)}}catch(s){}if(15===e.t)return U("realTimeUser",e),void ce.markRead(e.i,e.a);Le&&Le.uuid===a||15===e.t?(ce.markRead(e.i,e.a),e.unread=!1):(Ie[a]="undefined"==typeof Ie[a]?1:Ie[a]+1,e.unread=!0),D(e.s,e.t).then(function(t){e.c=I(e),e.time=S(e.time),D(a).then(function(){if(!ve[a]||!ve[a][e.i]){var n={isMine:!1,msg:e.c,time:e.time,type:e.a[0],sender:t,fileType:e.t,uuid:a,msgId:e.i,unread:e.unread};switch(n.fileType){case 2:n.message="[图片]";break;case 3:n.message="[附件]";break;case 10:n.message="收到新的好友通知";break;default:n.message=angular.element(n.msg).text()}he[a].msg.push(n),n.unread&&Ue.unshift(n),re(a),U("wsMsg",e,n)}})})}}),ce.on("error",function(e){U("wsError",e)}),ce.on("close",function(e){U("wsClose",e)})}function O(e,t,n){if(!ce)return x("尚未连接服务器。"),!1;if(!n)return x("不能发送空白消息"),!1;var a={t:t||0,r:[e.uuid],c:n};n=I(a),ce.sms2(a);var r={time:S((new Date).getTime()),isMine:!0,msg:n,sender:Te,senderId:Te.uuid,fileType:t,id:e.id};he[e.uuid].msg.push(r),re(e.uuid),U("wsSendMsg",e,r)}function P(){return u().then(function(e){Ee.splice(0,Ee.length),angular.forEach(e.data,function(e){var t={};angular.forEach(e.users,function(e){var n={name:e.name,id:e.id,img:e.img,online:!!e.online,role:e.role,type:"user",uuid:e.uuid,msg:[]};R(n),t[n.uuid]?t[n.uuid].role=[t[n.uuid].role,n.role].join(","):t[n.uuid]=n}),e.teachers=t,Ee.push(e)})})}function F(){return j().then(function(e){Te.id=e.data.id,Te.name=e.data.name,Te.img=e.data.img,Te.uuid=e.data.uuid,Te.type="user",U("userLogin",Te),angular.forEach(we,function(e){e.users.splice(0,e.users.length)}),angular.forEach(e.data.friendGrp,function(e){var t=[];angular.forEach(e.users,function(e){var n={type:"user",name:e.name,id:e.id,img:e.img,uuid:e.uuid,online:!!e.online};R(n),"COURSE_GRP"===e.type&&(n.type="group",n.online=!0,we["C-GRP"].users.push(n)),"CHAT_GRP"===e.type&&(n.type="group",n.online=!0,we["My-GRP"].users.push(n)),t.push(n)}),we[e.gType]&&(we[e.gType].users=t)})}).then(function(){angular.forEach(we,function(e){E(e.users)})})}function q(){return c().then(function(e){angular.forEach(e.data,function(e){angular.forEach(we,function(t){e.gType===t.type&&angular.forEach(e.users,function(e){var n={type:"user",name:e.name,id:e.id,img:e.img,uuid:e.uuid,online:!!e.online};t.users.push(R(n))})})})})}function z(e){xe.cid=e.data.cid,xe.oid=e.data.oid,xe.uuid=e.data.ugid,xe.gType=e.data.gType,xe.course=e.data.course,"CHAT_GRP"===xe.gType?xe.userList.member.users=e.data.users:angular.forEach(xe.userList,function(t){t.users.splice(0,t.users.length),angular.forEach(e.data.users,function(e){if(-1!==t.role.indexOf(e.role)){var n={id:e.id,img:e.img,role:[e.role],uuid:e.uuid,type:e.type,name:e.name},a=!1;angular.forEach(t.users,function(t){e.id===t.id&&(t.role.push(e.role),a=!0)}),a||t.users.push(n)}})})}function H(e){if(Ce[e]){var n=t.defer();return xe=Ce[e],n.resolve(),n.promise}return j(e).then(function(e){return e.data.cid?o({url:"get-course",method:"GET",params:{id:e.data.cid},option:{loading:!1}}).then(function(t){return e.data.course=t.data,z(e),e}):(z(e),e)})}function K(){return g().then(function(e){angular.forEach(e.data,function(e){var t={name:e.alias,img:e.img,uuid:e.r,type:0===e.type?"group":"user",id:+e.r.split("-")[1],online:0===e.type?!0:!!e.online,isGuest:!!e.tour};$e.push(R(t))}),E($e)})}function W(){var e=!1;return Se.splice(0,Se.length),v().then(function(t){angular.forEach(t.data,function(t){t.date=S(t.time||(new Date).getTime()).split(" ")[0],1===t.status&&(e=!0),Se.push(t)})}).then(function(){return v("r").then(function(e){angular.forEach(e.data,function(e){e.date=S(e.time||(new Date).getTime()).split(" ")[0],e.mine=!0,Se.push(e)})})}).then(function(){e&&U("hasUnhandleRequest")})}function V(){w("get offline message")}function B(){return M()}function J(e){e.wrap("<form>").parent("form").trigger("reset"),e.unwrap()}function Y(e){be=e,2===e?angular.element("#"+pe).click():angular.element("#"+ue).click()}function X(e,n){function a(){var e=t.defer();return"undefined"!=typeof C4js&&"function"==typeof C4js.Uer?e.resolve():$.getScript("common/directive/upload/upload-plugin.js",function(){e.resolve()}),e.promise}return n&&"image"===n?pe=e:ue=e,a().then(function(){var t=["png","jpg","bmp","gif","jpeg"],n=function(e){var n=!0;return 2===be&&angular.forEach(e.files,function(e){var a=e.name.split(".").pop().toLowerCase();-1===t.indexOf(a)&&(x("只支持以下格式图片上传：png,jpg,bmp,gif,jpeg。"),n=!1,J(angular.element("#chat-upload")))}),n?e.files:{}};de=new C4js.Uer(me.uploadSrv,{m:"C",token:Ae},!0),de.AddI(e,{pub:1,picType:2},{OnProcess:function(e,t,n){e.obj=e.obj||{},e.obj.rate=t,e.obj.speed=n,e.obj.status="uploading",w("upload progress "+e.obj.rate),U("uploadProgress",e,t,n)},OnSuccess:function(e,t){e.obj=e.obj||{};var n=t.data,a={name:e.name,path:"",Sha:"",type:e.type,url:n,size:e.size};e.obj.status="finish",O(Le,be,JSON.stringify(a)),U("uploadSuccess",e,t)},OnErr:function(e,t,n){e.obj=e.obj||{},e.obj.status="error",e.obj.error=n,U("uploadError",e,t,n)},OnAbort:function(e){e.obj=e.obj||{},e.obj.status="abort",U("uploadAbort",e)},OnStart:function(e){e.obj=e.obj||{},e.obj.status="uploading",e.obj.id=e.fid,U("uploadStart",e)},OnLoad:function(e,t){U("uploadLoad",e,t)}}),de.OnSelect=function(e){var t=n(e);return de.Args.token=Ae,angular.forEach(t,function(e){var t={};t.status="add",t.size=L(e.size),t.name=e.name,he[Le.uuid].msg.push({time:S((new Date).getTime()),uploadingMsg:!0,file:t,isMine:!0,sender:Te,uuid:Le.uuid}),U("uploadSelect",e),w("select upload file "+e.name),e.obj=t}),t}})}function Q(e){13===e.which?(Z(ge),U("sendScreenshot")):27===e.which&&(ee(),U("cancelScreenshot"))}function Z(e){if(angular.element(document).off("keydown",Q),!e)return void x("暂无截图。");if(!Le)return void x("请选择需要发送截图的好友。");var n={status:"uploading",rate:0,speed:0,name:"截图文件",size:0},a=function(e){var a=new XMLHttpRequest,r=a.upload,i=t.defer();a.onreadystatechange=function(){if(4===a.readyState&&200===a.status)try{var e=JSON.parse(a.responseText);i.resolve(e),U("screenshotUploadFinish",e)}catch(t){i.resolve(a.responseText),U("screenshotUploadFinish",a.responseText)}},r.addEventListener("progress",function(e){if(e.lengthComputable){var t=e.loaded/e.total;n.rate=t}U("screenshotUploadProgress",n,e)}),r.addEventListener("load",function(e){U("screenshotUploadLoad",n,e)}),r.addEventListener("error",function(e){n.status="error",U("screenshotUploadError",n,e)});var o={m:"C",pub:"1",picType:1,fileName:"screenshot.png",base64:1,token:Ae},s=[];angular.forEach(o,function(e,t){s.push(t+"="+e)});var c=me.uploadSrv+"?"+s.join("&");return a.open("post",c),a.send(e),i.promise};he[Le.uuid].msg.push({time:S((new Date).getTime()),uploadingMsg:!0,file:n,isMine:!0,sender:Te,uuid:Le.uuid}),U("sendScreenshot"),a(e.split(",")[1]).then(function(e){if(301===e.code)return void x("登陆超时！请重新登陆。");if(0!==e.code)return void x("上传截图失败！请重新上传。");var t={name:e.ext.url.split("/").pop(),path:"",Sha:"",type:"image",url:e.data,size:1};n.status="finish",O(Le,2,JSON.stringify(t)),U("sendScreenshotMsg")})}function ee(){ge="",angular.element(document).off("keydown",Q),U("cancelScreenshot")}function te(e){e.on("paste",function(t){angular.forEach(t.originalEvent.clipboardData.items,function(t){if("file"===t.kind&&/image\/\w+/.test(t.type)){var n=t.getAsFile(),a=new FileReader;a.onloadend=function(){ge=this.result,U("showScreenshot",ge),angular.element(document).on("keydown",Q),e.blur()},a.readAsDataURL(n)}})})}function ne(e){de.Abort(e)}function ae(e,t){var n=e.splice(t,1)[0];e.unshift(n)}function re(e){for(var t,n=0,a=0,r=!1;n<$e.length;n+=1)if(t=$e[n],t.uuid===e){r=!0,ae($e,n);break}r||(w("could not find popup user, will shift the user to the list"),$e.unshift(he[e]));for(n in we)if(we.hasOwnProperty(n)){var i=we[n];for(a=0;a<i.users.length;a+=1)if(t=i.users[a],t.uuid===e){ae(i.users,a);break}}}function ie(e){D(e).then(function(e){var t=angular.element(".online-chat").scope();t?t.open(e,!0):x("无法找到即时通讯组件。")})}function oe(e){Ae=e}var se,ce,le,de,ue,ge,pe,me=g_conf,fe=[].slice,he={},ve={},ye="localhost"===window.location.hostname,ke={},be=2,we={"S-GRP":{name:"我的学生",users:[],type:"S-GRP",order:1},"C-GRP":{name:"学习群组",users:[],type:"C-GRP",order:3},"T-GRP":{name:"我的老师",users:[],type:"T-GRP",order:4},"My-GRP":{name:"我的讨论组",users:[],type:"My-GRP",order:5},DEFAULT:{name:"我的好友",users:[],type:"DEFAULT",order:2}},xe={userList:{teachers:{name:"老师",users:[],role:["GUIDE","ANSWER"],isTeacher:!0},students:{name:"学生",users:[],role:["MEMBER"],isTeacher:!1},member:{name:"讨论组成员",users:[],role:[""]}},cid:0,gType:"",oid:0,uuid:""},Ce={},Te={},$e=[],Le={},Ie={},Se=[],Ae=r(),Ue=[],Ee=[];return A("enterChat",function(e){Le=e,Ie[Le.uuid]=0,he[e.uuid]||(e.msg=[],he[e.uuid]=e);for(var t=!1,n=0;n<$e.length;n+=1)if($e[n].uuid===e.uuid){t=!0;break}t||$e.unshift(e);var a=he[Le.uuid].msg,r=[];if(angular.forEach(a,function(e){e.unread&&(r.push(e.msgId),e.unread=!1)}),r.length){var i;i="U-00"===Le.uuid?"U-0":Le.uuid,ce.markRead(r.join(","),i)}for(n=0;n<Ue.length;n+=1)Ue[n].uuid===e.uuid&&(Ue.splice(n,1),n-=1)}),A("closeChat",function(){Le=null}),A("hasUnhandleRequest",function(){for(var e=!1,t=0;t<$e.length;t+=1)if("U-0"===$e[t].uuid){e=!0;break}if(!e){var n={type:"friendNotify",name:"系统通知",img:"images/icon/friend-notify.png",id:0,uuid:"U-0",online:!0};$e.unshift(R(n))}}),{http:{anonymousLogin:s,getUserGroups:c,getUserInfo:l,getGroup:d,getRecentUser:g,searchUser:m,requestFriend:f,handleFriendRequest:h,getNotify:v,createGroup:y,getGuideTeacher:k,getServeList:u,getAnswerTeacher:b},util:{getToken:r,log:x,saveToken:C,devlog:w,parseSize:L,parseTime:S,parseMsg:I,popUpUser:re,request:o},on:A,trigger:U,ws:{init:B,login:G},api:{getUserOrGroupInfo:j,getSender:D,clearFileInput:J,selectUploadFile:Y,initUploadPlugin:X,cancelUpload:ne,sendMsg:O,getOfflineMsg:V,getMyInfoAndGroup:F,getFriendsGroup:q,getRecentUser:K,getGroupDetail:H,
getRecordList:p,initTextInput:te,sendScreenshot:Z,cancelScreenshot:ee,unread:Ie,getFriendRequest:W,getAnonymousToken:_,websocket:ce,getServeList:P,changeUploadType:i,chatWithUser:ie,changeToken:oe},data:{self:Te,groupInfo:xe,groups:we,recentUser:$e,allUsers:he,friendRequests:Se,unreadMsgList:Ue,serveList:Ee}}}]),module.factory("dynamicService",function(){var e={emotions:"表情服务"};return function(){function t(){this._hash=new Object,this.put=function(e,t){return"undefined"!=typeof e&&0==this.containsKey(e)?(this._hash[e]="undefined"==typeof t?null:t,!0):!1},this.remove=function(e){delete this._hash[e]},this.size=function(){var e=0;for(var t in this._hash)e++;return e},this.get=function(e){return this._hash[e]},this.containsKey=function(e){return"undefined"!=typeof this._hash[e]},this.clear=function(){for(var e in this._hash)delete this._hash[e]}}var n=!0,a=new Array,r=new Array,i=new t,o="1362404091";$.ajax({dataType:"jsonp",url:"https://api.weibo.com/2/emotions.json?source="+o,success:function(e){switch(e.code){case 1:for(var t=e.data,o=0;o<t.length;o++)""==t[o].category&&(t[o].category="默认"),void 0==a[t[o].category]&&(a[t[o].category]=new Array,r.push(t[o].category)),a[t[o].category].push({name:t[o].phrase,icon:t[o].icon}),i.put(t[o].phrase,t[o].icon);n=!1,l&&l.ready();break;default:jf.alert(e.data.error)}},error:function(){jf.alert("表情数据请求失败")}});var s,c,l,d,u,g,p,m="#emotions",f="#emotions .container",h="#emotions .container a",v="#emotions .categorys",y="#emotions .categorys a",k="#emotions .prev",b="#emotions .next",w="#emotions .page",x="#emotions .page a";e.emotions={emotions:a,categorys:r,uSinaEmotionsHt:i,viewLocate:function(){var e,t=$(d).offset().top+$(d).outerHeight(!0),n=$(d).offset().left+$(d).width()/2-29,a=$(window).width(),r=$(document).height(),i=$(d).outerWidth(!0),o=$(m).outerWidth(!0),s=$(d).outerHeight(!0),c=$(m).outerHeight(!0),l=$(m).outerHeight(!0)/2+$(d).outerHeight(!0)/2,u=c>r-t,g=c>t-s,p=n+o>a,f=o>n,h=function(){p&&(u=l>r-t,g=l>t-s),n-=o+10,e=!u&&g?"r r1":u&&!g?"r r3":"r r2",t-=!u&&g?30:u&&!g?c:l},v=function(){e="l",n+=i,t-=l},y=function(){e="b",t-=c+s};u&&g?f?v():h():p?h():u&&y(),$(m).find(".ag-ic").addClass(e),$(m).css({top:t,left:n})},show:function(e,t){return $(document).unbind("click").bind("click",function(){$(m).remove()}),l=this,d=e.target,g=$(e.dyeditor).get(0),p=t,$(m).length?(u==d?$(m).remove():l.viewLocate(),void(u=d)):(u=d,$("body").append('<div id="emotions"></div>'),$(m).html('<span class="ag-ic"><i></i><em></em></span><div>正在加载，请稍候...</div>'),$(m).click(function(e){e.stopPropagation()}),$(m).find(".ag-ic").click(function(){$(m).remove()}),l.ready(),void l.viewLocate())},ready:function(){!n&&$(m).length&&($(m).html('<span class="ag-ic"><i></i><em></em></span><div style="float:right"><a href="javascript:void(0);" class="prev">&laquo;</a><a href="javascript:void(0);" class="next">&raquo;</a></div><div class="categorys"></div><div class="container"></div><div class="page"></div>'),$(m).find(".ag-ic").click(function(){$(m).remove()}),$(k).click(function(){l.showCategorys(c-1)}),$(b).click(function(){l.showCategorys(c+1)}),l.showCategorys(),l.showEmotions(),l.viewLocate())},showCategorys:function(){var e=arguments[0]?arguments[0]:0;if(!(0>e||e>=r.length/5)){$(v).html(""),c=e;for(var t=5*e;5*(e+1)>t&&t<r.length;++t)$(v).append($('<a href="javascript:void(0);">'+r[t]+"</a>"));$(y).click(function(){l.showEmotions($(this).text())}),$(y).each(function(){$(this).text()==s&&$(this).addClass("current")})}},showEmotions:function(){var e=arguments[0]?arguments[0]:"默认",t=arguments[1]?arguments[1]-1:0;$(f).html(""),$(w).html(""),s=e;for(var n=72*t;72*(t+1)>n&&n<a[e].length;++n)$(f).append($('<a href="javascript:void(0);" title="'+a[e][n].name+'"><img src="'+a[e][n].icon+'" alt="'+a[e][n].name+'" width="22" height="22" /></a>'));$(h).click(function(){l.insertText($(this).attr("title")),$(m).remove()});for(var n=1;n<a[e].length/72+1;++n)$(w).append($('<a href="javascript:void(0);"'+(n==t+1?' class="current"':"")+">"+n+"</a>"));$(x).click(function(){l.showEmotions(e,$(this).text())}),$(y+".current").removeClass("current"),$(y).each(function(){$(this).text()==e&&$(this).addClass("current")}),$(m).css({minHeight:254})},insertText:function(e){l.inCursorInsertAtCaret(l.AnalyticEmotion(e),g),p&&p($(g).html())},inCursorInsertAtCaret:function(e,t){var n,a;if(window.getSelection&&window.getSelection().getRangeAt){var r=window.getSelection(),i=r.focusNode;i&&(r=r.getRangeAt(0)),$(t).focus(),n=window.getSelection(),a=n.getRangeAt(0),a.startOffset==a.endOffset?i&&r.startContainer==a.startContainer||(a.selectNodeContents(t),a.setStart(a.endContainer,a.endOffset),a.setEnd(a.endContainer,a.endOffset)):a.deleteContents();var o=document.createElement("div");o.innerHTML=e;for(var s,c,l=document.createDocumentFragment();s=o.firstChild;)c=l.appendChild(s);a.insertNode(l,c),c&&(a=a.cloneRange(),a.setStartAfter(c),a.collapse(!0),n.removeAllRanges(),n.addRange(a))}else document.selection&&document.selection.createRange&&($(t).focus(),document.selection.createRange().pasteHTML(e))},AnalyticEmotion:function(e){if("undefined"!=typeof e){var t=e.match(/\[.*?\]/g);if(t)for(var n=0;n<t.length;n++)if(i.containsKey(t[n])){var a='<img src="'+i.get(t[n])+'" height="22" width="22" />';e=e.replace(t[n],a)}}return e}}}(),e}),module.directive("addface",function(){return{restrict:"A",scope:{data:"=addface"},controller:["$scope","$element","$timeout","dynamicService",function(e,t,n,a){t.on({click:function(n){a.emotions.show({dyeditor:t.attr("bindeditor"),target:t.get(0)},function(t){e.data=t}),n.stopPropagation()}})}]}}),module.directive("dyeditor",function(){return{template:'<div class="dyeditor-w"><div class="stint-chac"><span ng-class="{\'c-gray\':exceed}" ng-hide="exceed">还可以输入<b class="text1">{{surplus}}</b>字</span> <span ng-class="{\'c-red\':exceed>0}" ng-show="exceed">已超出<b class="text1">{{exceed}}</b>字</span></div><div class="placeholder" ng-hide="model&&model!==\'<br>\'">{{config.placeholder}}</div><div class="contenteditable" contenteditable="true" id="{{config.id}}" ng-style="config.style" ng-focus="onfocus()" ng-blur="onblur()" ng-click="change()"></div></div>',restrict:"E",replace:!0,transclude:!0,scope:{model:"=model",exceed:"=exceed",config:"=config"},controller:["$scope","$element","$attrs","$timeout",function(e,t,n,a){function r(){$(i).html()!==o&&(o=$(i).html(),i.click()),setTimeout(r)}var i=t.find(".contenteditable").get(0);e.surplus=e.config.len,e.checkLen=function(t){if(e.config.len){var n=$(t).text(),a=2*parseInt(e.config.len),r=0;n&&(r=parseInt(n.length)),e.exceed=r>a?Math.ceil((r-a)/2):0,e.surplus=n&&r>a?0:n?parseInt((a-r)/2):parseInt(e.config.len)}},e.change=function(t){e.model=void 0!==t?t:$(i).html(),e.config.len&&e.checkLen(i)},e.onfocus=function(){e.config.len&&t.find(".stint-chac").show(),e.focus=!0},e.onblur=function(){t.find(".stint-chac").css({display:e.exceed?"block":"none"}),e.focus=!1},e.$watch("model",function(n,a){void 0!==typeof n&&n!==$(i).html()&&($(i).html(n),e.config.len&&e.checkLen(i),t.find(".stint-chac").css({display:e.exceed?"block":"none"}))});var o=$(i).html();r()}]}}),module.filter("filterDynamicHtml",["$sce","dynamicService",function(e,t){return function(n){return e.trustAsHtml(t.emotions.AnalyticEmotion(n))}}]),module.filter("bindHtml",["$sce",function(e){return function(t){return e.trustAsHtml(t)}}]),angular.module("RCP").directive("imageSlider",function(){return{template:'<div class="image-slider"><style type="text/css">.image-slider-wrapper{padding:10px;background:#f2f2f2}.slider-action li{display:inline-block;margin-right:5px}.slider-action a{color:#999}.slider-action img{width:13px;height:13px;margin-right:4px}.slider-main{margin:10px 0;background:#fff;padding:5px;text-align:center;overflow:hidden;-ms-user-select:none;user-select:none;-webkit-user-select:none;-moz-user-select:none}.slider-main.right{cursor:url(/img/pic_next.cur),auto}.slider-main.left{cursor:url(/img/pic_prev.cur),auto}.slider-all ul{display:block;padding:0 25px;white-space:nowrap;vertical-align:middle;overflow:hidden;width:100%;word-wrap:normal}.slider-all li{display:inline-block;position:relative;-moz-transition:all .3s;-o-transition:all .3s;transition:all .3s}.slider-all .slider-images{width:45px;height:45px;padding:2px;cursor:pointer;border:2px solid transparent}.slider-all .slider-images.active{border:2px solid #6baef8}.slider-all{position:relative;overflow:hidden}.slider-all .nav-btn{display:block;position:absolute;top:0;bottom:0;padding:15px 5px;color:#bfbfbf;border:1px solid #e5e5e5;vertical-align:middle;text-decoration:none;background:#F7F7F7;z-index:10}.slider-all .nav-btn.left{left:0}.slider-all .nav-btn.right{right:0}.slider-all .nav-btn.active{color:#fff;background:#FFAD8F}.prev-list{margin-top:-5px}.prev-list li{border:none;display:inline-block;margin-right:5px;margin-top:5px}.prev-list .s-img{width:80px;height:80px;cursor:pointer}</style><ul class="prev-list" ng-hide="show"><li ng-repeat="img in images track by $index"><ng-img c="{img:img}" class="s-img" ng-click="showBigPic($index)"></ng-img></li></ul><div ng-show="show" class="image-slider-wrapper"><div class="slider-action"><ul><li><a ng-click="show=false" href="javascript:;"><i class="fa fa-long-arrow-up"></i> 收起</a></li><li><a ng-href="{{images[currentImage]}}" target="_blank"><i class="fa fa-search-plus"></i> 查看大图</a></li><li><a ng-click="turnLeft()" href="javascript:;"><i class="fa fa-undo"></i> 向左旋转</a></li><li><a ng-click="turnRight()" href="javascript:;"><i class="fa fa-repeat"></i> 向右旋转</a></li></ul></div><div class="slider-main {{cursor}}" ng-click="nextOrPrev()" ng-mousemove="showCursor($event)"><img ng-src="{{images[currentImage]}}" alt="" ng-style="{\'max-width\': bigImgWidth, \'max-height\': 325, transform: \'rotate(\' + rotateDeg() + \'deg)\',\'-webkit-transform\': \'rotate(\' + rotateDeg() + \'deg)\', \'-ms-transform\': \'rotate(\' + rotateDeg() + \'deg)\', \'-moz-transform\': \'rotate(\' + rotateDeg() + \'deg)\', transition:\'all 0.2s\'}"></div><div class="slider-all"><a href="javascript:;" ng-class="{active: showToggle(\'left\')}" ng-click="toggleSlide(\'left\')" class="nav-btn left">&lt</a><ul style="width:{{imageListWidth}}px"><li ng-repeat="img in images track by $index" style="left:{{left}}px"><ng-img c="{img:img,divClass:{active: currentImage==$index}}" ng-click="switchImg($index)" alt="" class="slider-images"></ng-img></li></ul><a href="javascript:;" ng-class="{active: showToggle(\'right\')}" ng-click="toggleSlide(\'right\')" class="nav-btn right">&gt</a></div></div></div>',restrict:"E",scope:{images:"=",loop:"="},controller:["$scope","$element","$timeout",function(e,t,n){var a=['<style id="image-slider-style">',".image-slider-wrapper {","padding: 10px;","background: #f2f2f2;","}",".slider-action li {","display: inline-block;","margin-right: 5px;","}",".slider-action a {","color: #999999;","}",".slider-action img {","width: 13px;","height: 13px;","margin-right: 4px;","}",".slider-main {","margin: 10px 0;","background: #fff;","padding: 5px;","text-align: center;","overflow: hidden;","user-select: none;","-webkit-user-select: none;","-moz-user-select: none;","}",".slider-main.right {",'cursor: url("/rcp-common/imgs/icon/pic_next.png"), auto;',"}",".slider-main.left {",'cursor: url("/rcp-common/imgs/icon/pic_prev.png"), auto;',"}",".slider-all ul {","display: inline-block;","white-space: nowrap;","vertical-align: middle;","overflow: hidden;","}",".slider-all li {","display: inline-block;","position: relative;","transition: all 0.3s;","}",".slider-all .slider-images {","width: 45px;","height: 45px;","padding: 2px;","cursor: pointer;","border: 2px solid rgba(0,0,0,0);","}",".slider-all .slider-images.active {","border: 2px solid #6baef8;","}",".slider-all .nav-btn {","display: inline-block;","padding: 15px 5px;","color: #bfbfbf;","border: 1px solid #e5e5e5;","vertical-align: middle;","text-decoration: none;","background: #F7F7F7;","}",".slider-all .nav-btn.active {","color: #fff;","background: #FFAD8F;","}",".prev-list li {","border: none;","display: inline-block;","margin-right: 5px;","}",".prev-list .s-img {","width: 80px;","height: 80px;","cursor: pointer;","}","</style>"].join("");angular.element("#image-slider-style").length||angular.element("body").append(a),e.turnLeftCount=e.turnRightCount=0,e.imageListWidth=0,e.bigImgWidth=0,e.bigImgOffset={top:0,left:0},e.$watch("show",function(a){a&&(e.wrapperWidth=t.find(".image-slider").width(),e.bigImgWidth=e.wrapperWidth-20,e.imageListWidth=e.wrapperWidth-76,n(function(){e.bigImgOffset=t.find(".slider-main").offset()},100))}),e.showBigPic=function(t){e.show=!0,e.switchImg(t)},e.switchImg=function(t){e.currentImage=t,e.turnLeftCount=e.turnRightCount=0},e.showCursor=function(t){if(e.images){if(e.images.length<2)return void(e.cursor="");var n=t.pageX-e.bigImgOffset.left;n>e.bigImgWidth/2?e.loop||e.currentImage<e.images.length-1?e.cursor="right":e.cursor="":e.loop||e.currentImage>0?e.cursor="left":e.cursor=""}},e.nextOrPrev=function(){e.images&&("left"===e.cursor?e.loop&&0===e.currentImage?e.switchImg(e.images.length-1):e.switchImg(e.currentImage-1):"right"===e.cursor&&(e.loop&&e.currentImage===e.images.length-1?e.switchImg(0):e.switchImg(e.currentImage+1)))},e.turnLeft=function(){e.turnLeftCount=e.turnLeftCount+1},e.turnRight=function(){e.turnRightCount=e.turnRightCount+1},e.rotateDeg=function(){return 90*(e.turnRightCount-e.turnLeftCount)},e.left=0,e.showToggle=function(t){if(e.images){var n=58;return"right"===t?n*e.images.length+e.left>e.imageListWidth:"left"===t?e.left<0:void 0}},e.toggleSlide=function(t){"right"===t&&e.showToggle(t)?e.left=e.left-e.imageListWidth:"left"===t&&e.showToggle(t)&&(e.left=e.left+e.imageListWidth)}}]}}),!module)var module=angular.module("RCP",[]);module.filter("sanitize",["$sce",function(e){return function(t){return e.trustAsHtml(t)}}]),module.directive("courseIntroRight",function(){return{template:'<div class="right-course-intro"><div class="right-course-contentDiv"><a ng-href="{{backToCourse}}" target="_blank"><img ng-src="{{info.imgUrl || \'/rcp-common/imgs/icon/gray-default-img.png\'}}" class="right-course-img"></a><h2 class="right-course-title"><a ng-href="{{backToCourse}}" target="_blank" ng-bind="info.title || \'暂无标题\'"></a></h2><table><tbody><tr><td class="table-left">创建者</td><td class="table-right">暂无</td></tr><tr><td class="table-left">导学老师</td><td class="table-right"><p ng-repeat="i in teachers" ng-bind="i.name"></p></td></tr><tr><td class="table-left">课程描述</td><td class="table-right">暂无</td></tr><tr><td class="table-left">课程服务态度</td><td class="table-right">暂无</td></tr><tr><td class="table-left">课程质量</td><td class="table-right">暂无</td></tr></tbody></table></div></div>',restrict:"E",replace:!0,transclude:!0,scope:{info:"="},controller:["$scope","course",function(e,t){var n={service:{list:{}}};e.init=function(){return e.info&&e.info.cid?void e.$watch("info",function(t){t.cid&&(e.backToCourse=rcpAid.getUrl("课程详情",{cid:e.info.cid,token:rcpAid.getToken()}),e.req.getCourseinfo().then(function(t){if(e.info.imgUrl=t.data.crs.imgs[0],e.info.title=t.data.crs.title,t.data.items.service){var n=t.data.items.service.list.service.uids,a=t.data.items.service.list.users;e.loadTeacher(n,a)}},function(e){console.log("获取课程详情失败"+e)}))},!0):void console.log("获取课程id失败")},e.req={getCourseinfo:function(){return t.getCourseDetail({cid:e.info.cid,cmds:angular.toJson(n)})}},e.loadTeacher=function(t,n){e.teachers=[],t.length?angular.forEach(n,function(t,n){console.log(t),e.teachers.push({name:t.attrs.basic.nickName})}):e.teachers.push({name:"nothing"})},e.$watch("info",e.init,!0)}]}}),module.factory("headSearch",["request",function(e){var t=g_conf.pes.rUrl;return{SearchIntelligent:function(n,a){var r={method:"GET",url:t+"pub/api/SearchIntelligent",params:n,option:{loading:!1}};return e(angular.extend(r,a||{}))}}}]),module.run(["service","headSearch",function(e,t){e.expand("headSearch",function(){return t})}]),module.directive("headnav",function(){return{template:'<header><div ng-class="headMaximizeLock ? \'head-maximize\' : \'head-minimize\'"><div ng-class="param.style"><div class="image-head-rainbow decoration-ic"></div><section class="g-m-w header-area"><div class="minimize-logo"><a ng-href="{{param.logo.href||\'/\'}}"><img ng-src="{{param.logo.small}}" alt="{{param.logo.msg}}" title="{{param.logo.msg}}"></a></div><nav class="minimize-nav"><ul><li ng-repeat="item in navList track by $index" ng-class="item.class"><a ng-href="{{item.href || \'\'}}" target="{{item.target || \'_self\'}}">{{item.name}}</a><div ng-if="item.child.length"><ul><li ng-repeat="c in item.child"><a ng-href="{{c.href || \'\'}}" target="{{c.target || \'_self\'}}">{{c.name}}</a></li></ul></div></li></ul></nav><div class="logo"><a ng-href="{{param.logo.href||\'/\'}}"><img ng-src="{{param.logo.large}}" alt="{{param.logo.msg}}" title="{{param.logo.msg}}"></a></div><div class="top-user-menu-bar" ng-class="{clearminw: user.account}"><top-user-menu user="user" item-list="itemList"></top-user-menu></div><div class="h-sc" ng-controller="headSearchCtrl"><div class="head-search-bar"><div class="enter" ng-click="stopPropagation($event)"><input type="text" class="input" ng-model="scText" ng-keydown="onkeydown($event)" ng-change="matchChange(scSelectVal.value,scText)" placeholder="请输入关键词搜索"><div class="match-kw-v" ng-show="matchReadyLock"><div class="mc-list"><ul><li ng-if="!mcCourseList || !mcCourseList.length">暂无相关内容</li><li ng-repeat="item in mcCourseList track by $index" ng-click="intoDetail(item)" ng-if="$index < cMaxLen" ng-class="{hover: $index + lMaxLen == moveKeyIndex}" ng-mouseenter="mouseenter($index, \'资源\')"><div class="text-of pd-r10"><span class="lab" ng-if="item.t == 10">课程</span> <span class="lab" ng-if="item.t == 20">题库</span> <a class="item-name" ng-bind-html="item.name | titleMatchKw:scText"></a></div></li></ul></div></div></div><a ng-click="goToSearch(scSelectVal.value,scText)" class="submit" title="提交"><i class="fa fa-search" aria-hidden="true"></i></a></div><div class="hot-word"><a ng-href="javascript:void(0);" ng-click="goToSort(item.name)" class="mg-r20" ng-repeat="item in scHotWord">{{item.name}}</a></div></div></section><section class="nav-area"><div class="g-m-w"><div class="n-categories" ng-controller="categoriesCtrl" ng-mouseenter="service.mouseenter(hover)" ng-mouseleave="service.mouseleave(hover)"><div class="dt">全部课程</div><div class="dd" id="by-categories" ng-show="categoriesUnfoldLock || hover.mouseEnterLock"><div class="image-giraffe giraffe-icon"></div><div class="dd-inner"><div class="item" ng-repeat="item in categoriesListStyle1 track by $index" ng-mouseenter="service.mouseenter(item)" ng-mouseleave="service.mouseleave(item)" ng-show="$index<5 || hover.mouseEnterLock"><div class="layer"><h3><a ng-href="goToCategory(item.name)" target="_blank" title="{{item.name}}">{{item.name}}</a></h3><div class="hot-word"><a ng-href="goToCategory(item.name,child.name)" target="_blank" class="text-of" ng-repeat="child in item.child track by $index" ng-show="$index<3" title="{{child.name}}">{{child.name}}</a></div><i>&gt;</i></div><div class="sub" ng-show="item.mouseEnterLock"><div class="inner"><dl class="card" ng-repeat="child in item.child track by $index" ng-show="$index<3"><dt><a ng-href="goToCategory(item.name,child.name)" target="_blank" class="f-r">更多&gt;&gt;</a> <a ng-href="goToCategory(item.name,child.name)" target="_blank" title="{{child.name}}">{{child.name}}</a></dt><dd><a ng-href="goToCategory(item.name,child.name,unit.name)" target="_blank" class="text-of" ng-repeat="unit in child.child track by $index" ng-show="$index<15" title="{{unit.name}}">{{unit.name}}</a></dd></dl><div class="more-srot" ng-show="item.child.length>3"><a ng-href="goToCategory(item.name)" target="_blank" class="f-r">更多分类&gt;&gt;</a>. . .</div></div></div></div><div ng-repeat="list in categoriesListStyle2 track by $index"><div class="big-sort"><a ng-href="goToCategory(item.name)" target="_blank" title="{{list.name}}">{{list.name}}</a></div><div class="item" ng-repeat="item in list.child track by $index" ng-mouseenter="service.mouseenter(item)" ng-mouseleave="service.mouseleave(item)"><div class="layer"><h3><a ng-href="goToCategory(list.name,item.name)" target="_blank" title="{{item.name}}">{{item.name}}</a></h3><i>&gt;</i></div><div class="sub" ng-show="item.mouseEnterLock"><div class="inner"><dl class="card" ng-repeat="child in item.child track by $index" ng-show="$index<4"><dt><a ng-href="goToCategory(list.name,item.name,child.name)" target="_blank" class="f-r">更多&gt;&gt;</a> <a ng-href="goToCategory(list.name,item.name,child.name)" target="_blank" title="{{child.name}}">{{child.name}}</a></dt><dd><a ng-href="goToCategory(list.name,item.name,child.name,unit.name)" target="_blank" class="text-of" ng-repeat="unit in child.child track by $index" ng-show="$index<10" title="{{unit.name}}">{{unit.name}}</a></dd></dl><div class="more-srot" ng-show="item.child.length>4"><a ng-href="goToCategory(list.name,item.name)" target="_blank" class="f-r">更多分类&gt;&gt;</a>. . .</div></div></div></div></div></div></div></div><nav class="nav"><a ng-repeat="item in navList track by $index" ng-href="{{item.href || \'\'}}" target="{{item.target || \'_self\'}}" ng-class="item.class">{{item.name}}</a></nav><div class="extra" ng-show=""><a href="javascript:void(0);" class="icf t-icf">名师认证</a> <a href="javascript:void(0);" class="icf e-icf">真实评价</a> <a href="javascript:void(0);" class="icf r-icf">随时退</a></div></div></section></div></div></header>',restrict:"E",replace:!0,transclude:!0,scope:{itemList:"=itemList",user:"=user",nav:"="},controller:["$rootScope","$scope","$element","$attrs","service",function(e,t,n,a,r){t.service=r,t.catType=parseInt(rcpAid.getCourseCat()),e.$watch("headMaximizeLock",function(e){e&&(t.headMaximizeLock=e)}),e.$watch("categoriesUnfoldLock",function(e){e&&(t.categoriesUnfoldLock=e)}),e.$watch("catDomain",function(e){if(e)switch(e){case"aikexue.com":t.init(2)}}),t.$on("login",function(e,n){n&&t.loginInit()}),t.loginInit=function(){3===t.catType&&(t.navList=[{name:"学习中心",href:rcpAid.getUrl("学习中心"),"class":"key",target:"_blank"},{name:"教学中心",href:rcpAid.getUrl("教学中心",{uid:t.user.tid}),"class":"key",target:"_blank"},{name:"高等教育",href:rcpAid.getUrl("分类",{category:"高等教育"}),"class":"key",target:"_blank"}])},t.init=function(e){if("order"===t.nav)return t.navList=[{name:"首页",href:rcpAid.getUrl("首页"),"class":"key"},{name:"个人空间",href:rcpAid.getUrl("学习中心"),"class":"key",target:"_blank"}],void(t.param={logo:{small:"/rcp-common/imgs/order/head-icon.png",large:"/rcp-common/imgs/icon/head-icon.png",href:"/my-order.html",msg:"我的酷校"},style:""});switch(t.catType){case 3:t.isLogin?t.navList=[{name:"学习中心",href:rcpAid.getUrl("学习中心"),"class":"key",target:"_blank"},{name:"教学中心",href:rcpAid.getUrl("教学中心",{uid:t.user.tid}),"class":"key",target:"_blank"},{name:"高等教育",href:rcpAid.getUrl("分类",{category:"高等教育"}),"class":"key",target:"_blank"}]:t.navList=[{name:"高等教育",href:rcpAid.getUrl("分类",{category:"高等教育"}),"class":"key",target:"_blank"}],t.param={logo:{small:"/rcp-common/imgs/icon/gzmooc-logo.png",large:"/rcp-common/imgs/icon/gzmooc-logo.png",href:DYCONFIG.rcp.rUrl,msg:"酷校 - 首页"},style:""};break;case 2:t.navList=[{name:"首页",href:rcpAid.getUrl("首页"),"class":"key"},{name:"全部课程",href:rcpAid.getUrl("分类"),"class":"key",target:"_blank"},{name:"学习中心",href:rcpAid.getUrl("学习中心"),"class":"key",target:"_blank"}],t.param={logo:{small:"/rcp-common/imgs/icon/aikexue-logo-2.png",large:"/rcp-common/imgs/icon/aikexue-logo.png",href:DYCONFIG.rcp.rUrl,msg:"爱科学"},style:"aikexue-head"};break;default:t.navList=[{name:"首页",href:rcpAid.getUrl("首页"),"class":"key"},{name:"学习中心",href:rcpAid.getUrl("学习中心"),"class":"key",target:"_blank"},{name:"我要吐槽",href:rcpAid.getUrl("我要吐槽"),"class":"key",target:"_blank"}],t.param={logo:{small:"/rcp-common/imgs/icon/book-logo-2.png",large:"/rcp-common/imgs/icon/book-logo.png",href:DYCONFIG.rcp.rUrl,msg:"酷校LOGO·让学习更Cool"},style:""}}},t.init()}]}}),module.directive("topUserMenu",function(){return{template:'<div class="top-user-menu"><div style="font-size:14px;line-height:40px" ng-show="!currentUser.uid"><a ng-href="{{link.login}}" id="login" class="color-cyan pd-l20"><i class="image-login-user-ic"></i>马上登录 </a><span style="color:#ececec;margin:0 8px">| </span><a ng-href="{{link.register}}" class="color-cyan">注册</a></div><div class="menber-link" ng-show="currentUser.uid"><a href="" class="u-info" rel="member_link"><img ng-hide="currentUser.avatar" src="/rcp-common/imgs/face/d-face-1.png" class="face-img" width="40" height="40" rel="user_face" alt="{{currentUser.nickName}}"> <img ng-show="currentUser.avatar" ng-src="{{currentUser.avatar}}" class="face-img" width="40" height="40" rel="user_face" alt="{{currentUser.nickName}}"> <span class="name" rel="user_name" title="{{currentUser.nickName}}" ng-bind="currentUser.nickName"></span> <i class="x-arrow-dowm">&gt;</i></a><div class="u-panel"><div class="tup-box"><div class="tup-info" rel="user_info_box"><div class="user-head" rel="user_face_box"><a ng-href="{{link.setting}}"><img ng-hide="currentUser.avatar" src="/rcp-common/imgs/face/d-face-1.png" width="96" height="96" class="face-img" rel="user_face" alt="{{currentUser.nickName}}"> <img ng-show="currentUser.avatar" ng-src="{{currentUser.avatar}}" width="96" height="96" class="face-img" rel="user_face" alt="{{currentUser.nickName}}"></a></div><div class="user-identity"><p class="user-name text-of"><a href="" rel="user_name" title="{{currentUser.nickName}}" ng-bind="currentUser.nickName"></a></p><p class="attestation-un" ng-class="{\'attestation\':attestation==\'已认证\'}"><i class="image-attestation-yellow"></i> <span>{{attestation}}</span></p></div><div class="clear"></div></div><div class="tup-operate"><div class="card-sets"><a href="{{link.applySpaceUrl}}" class="key f-l"><i class="image-attestation"></i> <span class="text-4f">认证管理</span> </a><a href="{{link.setting}}" target="_blank" class="key f-l"><i class="image-settings"></i> <span class="text-4f">设置</span> </a><a href="" class="key f-r" ng-click="logout()"><i class="image-logout"></i> <span class="text-4f">退出</span></a></div><div class="card-links"><a ng-repeat="item in itemList" ng-href="{{item.href || \'\'}}" ng-class="item.name == \'...\' ? \'disabled key \'+item.icon : \'key \'+item.icon"><i></i> <span>{{item.name}}</span></a></div></div></div></div></div></div>',restrict:"E",replace:!0,transclude:!0,scope:{itemList:"=itemList",user:"=user"},controller:["$rootScope","$scope","$timeout","$location","service",function(e,t,n,a,r){t.$watch("itemList",function(e){if(e){var n=t.itemList.length,a=n%3;if(a)for(var r=3-n%3+n,i=n;r>i;i+=1)e.push({name:"..."})}},!0),t.logout=function(){var e=rcpAid.getUrl("首页");location.href=rcpAid.getUrl("退出",{url:encodeURIComponent(e)})},t.$on("login",function(e,n){n.uid&&t.loginInit()}),t.loginInit=function(){t.currentUser=e.currentUser,t.currentUser.certification&&(t.attestation="已认证")},t.init=function(){var e=rcpAid.getNoTokenUrl();t.link={login:rcpAid.getUrl("登录",{url:encodeURIComponent(e)}),register:rcpAid.getUrl("注册",{url:encodeURIComponent(e)}),applySpaceUrl:rcpAid.getUrl("实名认证"),setting:rcpAid.getUrl("个人设置",{url:window.location.href})},t.attestation="未认证"},t.init()}]}}),module.controller("categoriesCtrl",["$rootScope","$scope","service",function(e,t,n){function a(e){switch(e){case 2:t.categoriesListStyle2=r||[];break;default:t.categoriesListStyle1=r||[]}}t.service=n,t.hover={},t.catType=rcpAid.getCourseCat(),t.byCategories=function(){t.byCategoriesLoading=!0,a(t.catType)},t.listenerMember={byCategories:{node:"#by-categories",callback:t.byCategories}};var r;t.goToCategory=function(){var e=[].slice;return rcpAid.getUrl("分类",{tags:e.call(arguments,0).join(",")})}}]),module.directive("searchDir",function(){return{template:'<div class="h-sc"><div class="head-search-bar"><div class="enter" ng-click="stopPropagation($event)"><input type="text" class="input" ng-model="scText" ng-keydown="onkeydown($event)" ng-change="matchChange(scSelectVal.value,scText)" placeholder="请输入关键词搜索"><div class="match-kw-v" ng-show="matchReadyLock"><div class="mc-list"><ul><li ng-repeat="item in mcCategoryList track by $index" ng-if="$index < lMaxLen" ng-class="{hover: $index == moveKeyIndex}" ng-mouseenter="mouseenter($index,\'类\')" ng-click="matchGoToCategory(item.tag,scText)"><div class="text-of"><a href="javascript:;">{{text}}</a> 在 <a href="javascript:;" class="item-name color-cyan">{{item.tag}}</a> 分类中搜索</div></li></ul><div style="margin:0 10px;border-top:1px solid #dfdfdf" ng-if="mcCourseList.length && mcCategoryList.length"></div><ul><li ng-if="!mcCourseList || !mcCourseList.length">暂无相关内容</li><li ng-repeat="item in mcCourseList track by $index" ng-click="intoDetail(item)" ng-if="$index < cMaxLen" ng-class="{hover: $index + lMaxLen == moveKeyIndex}" ng-mouseenter="mouseenter($index,\'资源\')"><div class="text-of"><span class="lab" ng-if="item.t == 10">课程</span> <span class="lab" ng-if="item.t == 20">题库</span> <a href="javascript:;" class="item-name" ng-bind-html="item.name|titleMatchKw:scText"></a></div></li></ul></div></div></div><a ng-click="goToSearch(scSelectVal.value,scText)" class="submit" title="提交"><i class="fa fa-search" aria-hidden="true"></i></a></div><div class="hot-word"><a href="" class="mg-r20" ng-repeat="item in scHotWord" ng-click="goToSort(item.name)">{{item.name}}</a></div></div>',restrict:"E",replace:!0,transclude:!0,scope:{hot:"="},controller:"headSearchCtrl"}}),module.controller("headSearchCtrl",["$rootScope","$scope","$document","$element","service","headSearch",function(e,t,n,a,r,i){function o(){t.scText="",u()}function s(){b=!0,t.KeyDownIndex=t.moveKeyIndex,d()}function c(){"number"!=typeof t.moveKeyIndex?t.moveKeyIndex=0:t.moveKeyIndex=(t.moveKeyIndex+1)%t.aMaxLen,s()}function l(){"number"!=typeof t.moveKeyIndex?t.moveKeyIndex=t.aMaxLen-1:t.moveKeyIndex=t.moveKeyIndex<0?t.aMaxLen-1:t.moveKeyIndex-1,s(),m(t.scText.length)}function d(){var e,n=t.KeyDownIndex,a=t.lMaxLen;return t.scTag=void 0,a>n&&(t.scText=t.text),n>=a&&(e=t.mcCourseList[n-t.lMaxLen],e&&(t.scText=e.name)),e}function u(e){t.matchReadyLock=!1,e&&(n.unbind("click"),t.$digest())}function g(){n.unbind("click").bind("click",function(){u("digest")}),t.matchReadyLock=!0}function p(){t.matchReadyLock&&(clearTimeout(w),w=setTimeout(function(){u("digest")},300))}function m(e){var t=a.find('input[ng-model="scText"]').get(0);if("selectionStart"in t&&(t.selectionStart=e,t.selectionEnd=e),"createTextRange"in t){var n=t.createTextRange();n.moveStart("character",e),n.collapse(!0),n.select()}}function f(e,n){t.inSort&&!angular.isArray(e)||angular.forEach(e,function(e){return t.inSort?!1:void(n(e)||angular.isArray(e.child)&&e.child.length&&(f(e.child,n),v("push",e.name)))})}function h(e,n){switch(t.inSort=!1,v("clear"),f(e,function(e){return t.inSort=e.name===n,t.inSort&&v("push",e.name),t.inSort}),t.inSort){case!0:v("splice",n);break;default:v("clear")}return t.categorySelect}function v(e,n){var a=t.categorySelect;switch(e){case"clear":a.splice(0,a.length);break;case"push":a.push(n);break;case"splice":a.splice(0,$.inArray(n,a))}}function y(e,t){r.dialog.alert(t),console[e](t)}function k(e){var t=[];if(e.length)for(var n=0,a=e.length;a>n;n++)t.push({id:e[n].hasOwnProperty("id")?e[n].id:"",name:e[n].hasOwnProperty("title")?e[n].title:"",t:e[n].hasOwnProperty("type")?e[n].type:""});return t}t.scHotWord=[],t.scSelect=[{name:"所有分类",value:"",fixLock:!0},{name:"课程",value:10},{name:"题库",value:20}],t.scSelectVal=t.scSelect[0],t.onkeydown=function(e){switch(e.stopPropagation(),e.keyCode){case 13:t.scText||(t.scText=$(".head-search-bar input").eq(0).val());var n=t.KeyDownIndex,a=t.lMaxLen;"number"==typeof n&&n>=0&&a>n&&t.scTag?t.matchGoToCategory(t.scTag,t.scText):n>=0&&t.matchReadyLock?location.href=rcpAid.getUrl("课程详情",{cid:t.mcCourseList[n].id}):t.goToSearch(t.scSelectVal.value,t.scText);break;case 38:l();break;case 40:c();break;default:b=!1,t.moveKeyIndex=void 0,
t.KeyDownIndex=void 0,t.scTag=void 0}};var b,w;a.find('input[ng-model="scText"]').unbind("focus").bind("focus",g),a.find('input[ng-model="scText"]').unbind("blur").bind("blur",p),t.mouseenter=function(e,n){switch(n){case"类":t.moveKeyIndex=e;break;case"资源":t.moveKeyIndex=e+t.lMaxLen}},t.goToSearch=function(e,t){o(),location.href=rcpAid.getUrl("搜索",{type:e,query:t?encodeURIComponent(t):t})},t.goToSort=function(e){o(),location.href=rcpAid.getUrl("分类",{tags:e})},t.stopPropagation=function(e){e.stopPropagation()},t.matchChange=function(e,n){if(!b){if(u(),!n)return t.mcCategoryList=[],void(t.mcCourseList=[]);t.text=n,i.SearchIntelligent({key:n,courseType:e||null,limit:10}).then(function(e){t.scText&&(t.matchReadyLock=!0,t.mcCourseList=k(e.data.courses||[]),t.mcCategoryList=[],t.lMaxLen=t.mcCategoryList.length>3?3:t.mcCategoryList.length,t.cMaxLen=t.mcCourseList.length-t.lMaxLen,t.aMaxLen=t.lMaxLen+t.cMaxLen,t.mcCourseList.length||t.mcCategoryList.length||u())},function(e){y("错误代码："+e.data.data.code)})}},t.$watch("scSelectVal.value",function(){t.matchChange(t.scSelectVal.value,t.scText)}),t.matchGoToCategory=function(t,n){if(!e.allTagCategroy||!e.allTagCategroy.length)return void y("error","获取分类数据失败");var a=h(e.allTagCategroy,t).reverse().join(",");a?(o(),location.href=rcpAid.getUrl("分类",{tags:a,query:n})):y("error","找不到这个分类，请检查接口数据")},t.categorySelect=[],t.intoDetail=function(e){e.hasOwnProperty("id")&&(location.href=rcpAid.getUrl("课程详情",{cid:e.id}))}}]),module.directive("tailnav",function(){return{template:'<footer><section class="footer" id="footer"><div class="g-m-w"><div class="copyright"><p>广州市大洋信息技术股份有限公司 版权所有</p><p>Copyright © 2015 ITDAYANG. All Rights Reserved.</p><p>{{caseNumber}}</p></div><div class="footer-link"><a href="http://www.itdayang.com/about.html" target="_blank">关于我们</a> <span>- </span><a href="http://www.itdayang.com/contact.html" target="_blank">联系我们</a> <span>- </span><a href="javascript:;" ng-click="atBuilding()">法律条款</a> <span>- </span><a href="javascript:;" ng-click="atBuilding()">帮助中心</a> <span>- </span><a href="javascript:;" ng-click="atBuilding()">学校申请加入</a> <span>- </span><a href="javascript:;" ng-click="atBuilding()">机构申请加入</a> <span>- </span><a href="javascript:;" ng-click="atBuilding()">意见反馈</a></div><div class="clear"></div></div></section></footer>',restrict:"E",replace:!0,transclude:!0,scope:{data:"=data"},controller:["$scope","service",function(e,t){e.catType=rcpAid.getCourseCat();var n=DYCONFIG.domain||[];angular.forEach(n,function(t){t.domain===location.host&&(e.caseNumber=t.domainNum)}),e.atBuilding=function(){t.dialog.alert("正在建设中...")}}]}}),module.filter("titleMatchKw",["$sce",function(e){return function(t,n){var a="<b>"+n+"</b>",r=/([\[\]\(\)\{\}\*\?\+\^\$\.\|\\])/gi,i=n.replace(r,"\\$1");return t=t.replace(new RegExp(i,"ig"),a),e.trustAsHtml(t)}}]),function(){function e(){var r=document.getElementById("footer");if(r){var i=document.documentElement.scrollHeight-1||document.body.scrollHeight-1,o=document.documentElement.clientHeight||document.body.clientHeight;a=o>=i?1:2,a!==n&&(o>=i?(t(r.parentNode,{height:r.offsetHeight+"px"}),t(r,{position:"absolute",width:"100%",bottom:0,left:0})):(t(r.parentNode,{height:r.offsetHeight+"px"}),t(r,{position:"",width:"100%",bottom:0,left:0}))),n=o>=i?1:2}setTimeout(e)}if(!window.fixedFooterFlag){window.fixedFooterFlag=!0;var t=function(e,t){for(k in t)e.style[k]=t[k]},n=0,a=1;e()}}(),module.directive("fixedToolbar",function(){return{template:'<div ng-class="\'fixed-toolbar \'+param.style"><div class="grid tab-top" title="回到顶部" onclick=\'$("html,body").stop().animate({scrollTop:0},"fast")\'><i class="ic"></i></div><div class="grid d-app"><i class="ic"></i><p class="font">App 下载</p><div ng-class="panelAmit ? \'panel panel-amit\' : \'panel\'"><div class="inner"><div class="img"><img ng-src="{{data.qr.src}}" width="122" height="122" rel="download_kuxiao_app_qr_code"></div><p>{{data.qr.name}}</p></div></div></div></div>',restrict:"E",replace:!0,transclude:!0,scope:{data:"=data"},controller:["$scope","$rootScope","$timeout",function(e,t,n){function a(){var e=$(".tab-top"),t=$(window).scrollTop();t>300?e.addClass("visible"):e.removeClass("visible")}a(),$(window).bind("scroll",a),$(window).bind("resize",a),e.param={},e.init=function(t){switch(t){case 2:e.param.style="aikexue-fixed-toolber"}},e.init(rcpAid.getCourseCat()),t.$watch("catDomain",function(t){if(t)switch(t){case"aikexue.com":e.init(2)}}),n(function(){e.panelAmit=!0},300)}]}}),module.directive("pagination",function(){return{template:'<div class="page-bar" ng-show="list.length>0"><a href="javascript:;" ng-class="current<=0?\'disabled\':\'\'" ng-click="prev()"><em class="emic">&lt;</em><em class="emf">上一页</em></a><a href="javascript:;" ng-repeat="key in keyList" ng-class="key==current ? \'cur\' : \'\'" ng-click="jump(key)">{{key+1}}</a><span ng-show="pLen>pMax && !hideEllipsis">...</span><a href="javascript:;" ng-class="current>=pLen-1?\'disabled\':\'\'" ng-click="next()"><em class="emf">下一页</em><em class="emic">&gt;</em></a><span class="jump-bar"><span>共<font class="blue-c">{{pLen}}</font>页</span><span>跳到 <input type="text" style="width:38px;height:19px;text-align:center;" ng-model="goKey"> 页</span><a href="" ng-click="go(goKey)">GO</a></span></div>',restrict:"E",replace:!0,transclude:!0,scope:{list:"=list",pagefn:"=pagefn",pageargs:"=pageargs",deepwatch:"="},controller:["$scope","$element","$attrs","service",function(e,t,n,a){e.$watch("pageargs",function(t,n){t&&(e.current=parseInt(e.pageargs.pn)-1,e.pageNode=e.current,e.pNum=parseInt(e.pageargs.ps),e.pMax=parseInt(e.pageargs.pl)||5,e.pagefn(e.pageargs,function(t){e.pLen=Math.ceil(parseInt(t.pa.total)/e.pNum),e.keyListWatch()}))},e.deepwatch),e.reKeyList=function(t,n,a){e.keyList=[];for(var r=t;n>r&&!(r>=a);r++)e.hideEllipsis=r+1==e.pLen,e.keyList.push(r)},e.keyListWatch=function(){var t=e.pLen;if(t>e.pMax){var n=Math.ceil(e.pMax/2),a=e.current;a>=n&&a<t-(e.pMax-n)?e.reKeyList(a-(e.pMax-n),a+n,t):a>=t-(e.pMax-n)?e.reKeyList(t-e.pMax,t,t):n>=a&&e.reKeyList(0,t,e.pMax)}else e.reKeyList(0,t,e.pMax)},e.jump=function(t){e.pageNode!=t&&(e.current=t,e.pageNode=t,e.pageargs.pn=t+1,e.pagefn(e.pageargs,function(t){e.pLen=Math.ceil(parseInt(t.pa.total)/e.pNum),e.keyListWatch()}))},e.next=function(){e.current++,e.current>=e.pLen&&(e.current=e.pLen-1),e.jump(e.current)},e.prev=function(){e.current--,e.current<=0&&(e.current=0),e.jump(e.current)},e.go=function(t){var n=/^-?\d+$/g;void 0==t||t.length<=0?a.dialog.alert("输入不能为空！",{}):n.test(t)?(parseInt(t)>e.pLen?(t=e.pLen,a.dialog.alert("总共只有"+e.pLen+"页，为您转到最后一页！",{})):parseInt(t)<=0&&(t=1,a.dialog.alert("不能低于第1页,为您转到最前一页！",{})),e.jump(parseInt(t)-1),e.goKey=void 0):t.match(/\s+/g)?a.dialog.alert("输入不能有空格符！",{}):a.dialog.alert("格式错误，请输入整数！",{})}}]}}),module.config(["$provide",function(e){e.decorator("$exceptionHandler",["$delegate",function(e){return function(t,n){e(t,n),console.error({origin:"AngularJS Error",msg:t.message,stack:t.stack}),document.runErrorCallUpgrade()}}])}]),module.controller("mainCtrl",["$scope","$rootScope","$http","service","$cookies","$timeout",function(e,t,n,a,r,i){function o(){var e=localStorage.getItem("anonymousLoginUsr");return e&&"error"!==e?(t.anonymousUser=JSON.parse(e),void(r.stoken=t.anonymousUser.token)):void n({method:"GET",url:"http://"+g_conf.SSO+"/sso/api/anonymousLogin"}).then(function(e){if(0!==e.data.code)return console.error(e.data.msg,"匿名登录失败"),void localStorage.setItem("anonymousLoginUsr","error");var n=e.data.data;n.usr.token=n.token,localStorage.setItem("anonymousLoginToken",n.token),delete n.usr.BAttr,delete n.usr.attrs,localStorage.setItem("anonymousLoginUsr",JSON.stringify(n.usr)),t.anonymousUser=n.usr,r.stoken=n.usr.token},function(e){localStorage.setItem("anonymousLoginUsr","error"),console.error(e,"匿名登录失败")})}function s(n){R.token=rcpAid.getToken(),e.setUserData(UINFO),l(t.currentUser.role),console.log("checkLogin by token")}function c(e){console.log("未登陆",e),rcpAid.isLogin=0,l({}),i(function(){t.$broadcast("login","")},0)}function l(t){function n(t){angular.forEach(t,function(t){var n=!1;angular.forEach(e.itemList,function(e){t.name===e.name&&(n=!0)}),n||e.itemList.push(t)})}function a(){var e=rcpAid.getUrl,t=[];return angular.forEach(arguments,function(n){switch(n){case"学习中心":t.push({ic:"L2",name:n,href:e(n)});break;case"教学中心":t.push({ic:"L2",name:n,href:e(n)});break;case"助学中心":"undefined"==typeof isIE||isIE(9,9)||t.push({ic:"L2",name:n,href:e(n)});break;case"管理中心":t.push({ic:"L1",name:n,href:e(n)});break;case"创建新课程":t.push({ic:"L4",name:n,href:e("创建课程",{type:10})})}}),t}e.itemList=[],angular.forEach(t,function(t,r){switch(r){case"default":break;case"student":e.user.schoolId&&n(a("学校空间")),e.user.classId&&n(a("班级空间"));break;case"parent":n(a("家长空间"));break;case"teacher":e.user.schoolId&&n(a("学校空间")),e.user.classId&&n(a("班级空间"));break;case"help":n(a("助学中心"));break;case"class":n(a("班级空间","学校空间"));break;case"school":n(a("学校空间"));break;case"UCS_ADMIN":n(a("管理中心"));break;case"COURSE_VERIFY_ADMIN":n(a("管理中心"));break;case"PAGE_EDIT_ADMIN":n(a("管理中心"))}}),n(a("学习中心","教学中心","创建新课程","创建新题库"))}function d(){return t.currentUser={},$("body").show(),a.common.checkLogin(s,c),rcpAid.isLogin?void 0:(console.log("未登陆"),void o())}$("body").show();try{R=new ars.ARS,R.args={},R.delay=1e3,R.pushDelay=1e4,R.url=DYCONFIG.ars.rUrl+"pub/api/record",R.token=rcpAid.getToken(),R.start()}catch(u){R={}}e.setUserData=function(e){try{if(console.log(e),!e.uid)return;t.currentUser={uid:e.usr.id,nickName:e.usr.attrs.basic.nickName,avatar:e.usr.attrs.basic.avatar,desc:e.usr.attrs.basic.desc,role:e.usr.attrs.role||""},e.usr.attrs.pass&&(t.currentUser.certification=e.usr.attrs.pass.certification),console.log("发广播",t.currentUser),i(function(){t.$broadcast("login",t.currentUser)},0)}catch(n){console.log(n)}},d()}]);